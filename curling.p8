pico-8 cartridge // http://www.pico-8.com
version 38
__lua__
function _init() -- once
  create_stats()
  active_stone=nil
  thrown_stones={}
  power=nil
  angle=nil
  show_angle_bar=false
  show_power_bar=false
  MID_POWER=89
  MID_ANGLE=55
  temp_angle=MID_ANGLE
  temp_power=MID_POWER
  player=0
end

function _update() -- 1/30 sec
  timer.time+=1

  if (show_angle_bar) then
    if (btnp(5)) then
      show_angle_bar=false
      angle=0
      -- angle=-5*(MID_ANGLE-temp_angle)/MID_ANGLE
    else
      if (temp_angle < 32) then
        incrementer=1.5
      elseif (temp_angle > 78) then
        incrementer=-1.5
      end

      temp_angle+=incrementer
    end
  end

  if (show_power_bar) then
    if (btnp(5)) then
      show_power_bar=false
      power=temp_power
    else
      if (temp_power < 52) then
        incrementer=1.5
      elseif (temp_power > 89) then
        incrementer=-1.5
      end
      temp_power+=incrementer
    end
  end
  
  if (btnp(5) and active_stone==nil and power==nil and angle==nil) then
    show_angle_bar=true
    temp_angle=MID_ANGLE
    temp_power=MID_POWER
    incrementer=-1.5
    pending_stone=create_stone(0, 0)
  end

  if (btnp(5) and active_stone==nil and power==nil and angle!=nil) then
    -- throw
    show_power_bar=true
  end

  -- have power/angle, throw
  if (power!=nil and angle!=nil) then
    if (player%2==0) then
      active_stone=create_stone(0,calculate_power(power),angle)
    else
      active_stone=create_stone(16,calculate_power(power),angle)
    end
    power=nil
    angle=nil
    incrementer=-1.5
    player+=1
  end


  if (active_stone) then
    if (active_stone.speed > 0) then
      stone.speed-=.5
      stone.x+=stone.angle
      stone.y+=-1*stone.speed
      -- sfx(0,-1,20)
      check_hit()
    else
      add(thrown_stones, active_stone)
      active_stone=nil
    end
  end

  if (timer.time >= 30) then
    timer.time=0
  end
end

function calculate_movement(stone,speed)
  
end

function calculate_power(power)
  return max(abs((90-power)/4+2),5)
end

function draw_angle_bar()
  rect(30,80,80,84,4)
  line(MID_ANGLE,81,MID_ANGLE,83,14)
end

function draw_power_bar()
  rect(123,50,127,90,4)
end

function check_hit()
  if (thrown_stones[1]) then
    local xs=8
    local ys=8
    local xd=abs((active_stone.x+(8/2))-(thrown_stones[1].x+(8/2)))
    local yd=abs((active_stone.y+(8/2))-(thrown_stones[1].y+(8/2)))

    print("xd: "..xd,40,40,0)
    print("yd: "..yd,40,50,0)
    if xd<xs and yd<ys then
      active_stone.speed=0
    end
    
    return hit
  end
end

function create_stats()
  timer={}
  timer.time=0
  p1_scores={}
  p1_scores[1]=1
  p1_scores[4]=5
  p1_scores[8]=8
  p2_scores={}
  p2_scores[3]=1
end

function _draw() -- once per frame
  cls(0)
  map(0,0,0,0,128,64)
  
  if (active_stone != nil) then
    spr(active_stone.player,active_stone.x,active_stone.y)
  end
  for i=0,#thrown_stones do
    if (thrown_stones[i] != nil) then
      spr(thrown_stones[i].player,thrown_stones[i].x,thrown_stones[i].y)
    end
  end
  
  if (show_power_bar) then
    draw_power_bar()    
    line(124,temp_power,126,temp_power,14)
    print("angle:"..angle,20,20,14)
  end

  if (show_angle_bar) then
    draw_angle_bar()
    print("angle: "..temp_angle, 50, 50, 11)
    line(temp_angle,81,temp_angle,83,15)
  end
  if (active_stone) then
    print("x:"..active_stone.x, 20,20,0)
    print("y:"..active_stone.y, 20,30,0)
  end
  
  if (thrown_stones[1]) then
    print("x:"..thrown_stones[1].x, 60,20,0)
    print("y:"..thrown_stones[1].y, 60,30,0)
  end
    draw_score()
end

function draw_score()
  rect(0,100,127,127,5) 
  rectfill(1,110,126,117,0)
  print("1 2 3 4 5 6 7 8 9 10", 30, 112, 15)
  p1_total=0
  for i=1,10 do
    if (p1_scores[i]!=nil) then
      print(p1_scores[i], 22 + (8*i), 105, 8)
    end
  end

  p2_total=0
  for i=1,10 do
    if (p2_scores[i]!=nil) then
      print(p2_scores[i], 22+(8*i), 119, 10)
    end
  end
end

function create_stone(player, power, angle)
  stone={}
  stone.player=player
  stone.angle=angle
  stone.speed=power
  stone.x=50
  stone.y=100
  return stone
end


__gfx__
0000000077777ccccccccccccc777777777777770000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000777ccccccccccccccccc7777777777770000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0055500077ccccccccccccccccccc777777777770000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
058885007cccc77777777777777ccc77777777770000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
058785007ccc7777777777777777ccc7777777770000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
05888500ccc777777777777777777cc7777777770000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00555000ccc777777888888777777ccc777777770000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000ccc777778888888877777ccc777777770000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000ccc777788888888887777ccc000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000ccc777888777777888777ccc000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00555000ccc777888777777888777ccc000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
05111500ccc777888777777888777ccc000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
05171500ccc777888777777888777ccc000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
05111500ccc777888777777888777ccc000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00555000ccc777888777777888777ccc000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000ccc777788888888887777ccc000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000ccc777778888888877777ccc000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000ccc777777888888777777ccc000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000000007cc777777777777777777cc7000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000000007ccc7777777777777777ccc7000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000077ccc77777777777777ccc77000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000777cccccccccccccccccc777000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000000007777cccccccccccccccc7777000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000777777cccccccccccc777777000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__map__
0404040404010203040404040404040400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0404040404111213040404040404040400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0404040404212223040404040404040400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0404040404040404040404040404040400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0404040404040404040404040404040400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0404040404040404040404040404040400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0404040404040404040404040404040400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0404040404040404040404040404040400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0404040404040404040404040404040400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0404040404040404040404040404040400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0404040404040404040404040404040400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0404040404040404040404040404040400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0404040404040404040404040404040400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0404040404040404040404040404040400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0404040404040404040404040404040400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0404040404040404040404040404040400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0404040404040404040404040404040400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0404040404040404040404040404040400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0404040404040404040404040404040400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0404040404040404040404040404040400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0404040404040404040404040404040400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0404040404040404040404040404040400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0404040404040404040404040404040400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__sfx__
000100000065000650016500265002650026500365003650026500265002650026500265002650016500165001650016500165001650016500165001650016500165001650016500165002650026500165001650
